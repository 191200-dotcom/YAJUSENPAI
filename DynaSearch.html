<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebPhone Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --main-green: #31B48D; --purple: #5856D6; --danger: #FF3B30; --bg: #f0f2f5; }
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 15px; }
        .container { background: white; padding: 25px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 340px; transition: max-width 0.4s ease; display: flex; flex-direction: column; align-items: center; }
        .container.in-call { max-width: 850px; flex-direction: row; gap: 20px; }
        .app-logo { width: 60px; height: 60px; background: var(--main-green); border-radius: 14px; display: flex; justify-content: center; align-items: center; margin-bottom: 8px; }
        #jst-clock { font-size: 10px; color: #999; font-weight: bold; margin-bottom: 12px; }
        .video-container { position: relative; width: 100%; height: 280px; background: #000; border-radius: 18px; margin-bottom: 15px; overflow: hidden; display: none; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .local-video-wrapper { position: absolute; bottom: 12px; right: 12px; width: 100px; height: 75px; border-radius: 10px; overflow: hidden; border: 2px solid #fff; z-index: 10; background: #222; }
        .mic-badge { position: absolute; top: 5px; left: 5px; width: 22px; height: 22px; background: white; border-radius: 4px; display: none; z-index: 30; padding: 3px; }
        .chat-corner { width: 100%; max-width: 320px; height: 350px; background: #f8f9fa; border-radius: 18px; display: none; flex-direction: column; padding: 15px; border: 1px solid #eaeaea; }
        #chat-log { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        .msg { max-width: 85%; padding: 8px 14px; font-size: 13px; border-radius: 16px; width: fit-content; }
        .msg-me { background: var(--main-green); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-them { background: #e4e6eb; color: #1c1c1e; align-self: flex-start; border-bottom-left-radius: 2px; }
        .status { font-size: 11px; font-weight: bold; margin-bottom: 15px; color: #888; }
        .card { width: 100%; background: #fdfdfd; padding: 15px; border-radius: 16px; border: 1px solid #f0f0f0; text-align: center; margin-bottom: 15px; }
        .my-id { font-size: 34px; font-weight: 800; color: #222; margin: 5px 0; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; margin-bottom: 10px; }
        button { border: none; font-weight: bold; cursor: pointer; border-radius: 12px; padding: 12px; transition: 0.2s; color: white; width: 100%; }
        .btn-gen { background: #222; }
        .btn-audio { background: var(--main-green); }
        .btn-video { background: var(--purple); }
        .controls { display: none; grid-template-columns: 1fr 1fr 1fr; gap: 8px; width: 100%; margin-top: 10px; }
        .btn-toggle { background: #555; font-size: 11px; }
        .btn-toggle.off { background: var(--danger); }
        #chat-send { background: var(--main-green); font-size: 18px; width: 50px; }
    </style>
</head>
<body>

<div id="container" class="container">
    <div style="width:100%; display:flex; flex-direction:column; align-items:center;">
        <div class="app-logo">
            <svg viewBox="0 0 24 24" fill="white" width="35"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
        </div>
        <div id="jst-clock">JST --:--:--</div>
        <div id="status" class="status">OFFLINE</div>
        
        <div id="v-area" class="video-container">
            <video id="remote-video" autoplay playsinline></video>
            <div class="local-video-wrapper">
                <video id="local-video" autoplay playsinline muted></video>
                <div id="mic-icon-svg" class="mic-badge">
                    <svg viewBox="0 0 24 24" width="16"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                </div>
            </div>
        </div>

        <div id="setup-area" style="width: 100%;">
            <div class="card">
                <div id="my-id-val" class="my-id">-----</div>
                <button id="gen-btn" class="btn-gen">番号を発行</button>
            </div>
            <input type="text" id="target-id" placeholder="相手の5桁を入力" maxlength="5">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button id="audio-btn" class="btn-audio">音声通話</button>
                <button id="video-btn" class="btn-video">ビデオ通話</button>
            </div>
        </div>

        <div id="call-controls" class="controls">
            <button id="toggle-mic" class="btn-toggle">MIC: ON</button>
            <button id="toggle-cam" class="btn-toggle">CAM: ON</button>
            <button id="hangup-btn" style="background:var(--danger)">終了</button>
        </div>
    </div>

    <div id="chat-area" class="chat-corner">
        <div id="chat-log"></div>
        <div style="display:flex; gap:8px;">
            <input type="text" id="chat-msg" placeholder="入力..." style="margin:0; height:42px;">
            <button id="chat-send">➤</button>
        </div>
    </div>
</div>

<audio id="remote-audio" autoplay></audio>

<script>
    const el = (id) => document.getElementById(id);
    let peer = null, localStream = null, currentCall = null, dataConn = null;

    // 時計
    setInterval(() => {
        const n = new Date();
        el('jst-clock').textContent = `JST ${n.getHours().toString().padStart(2,'0')}:${n.getMinutes().toString().padStart(2,'0')}:${n.getSeconds().toString().padStart(2,'0')}`;
    }, 1000);

    // 番号発行
    el('gen-btn').addEventListener('click', () => {
        if (typeof Peer === 'undefined') { alert("ライブラリを読み込み中です。数秒待ってから再度押してください。"); return; }
        if (peer) peer.destroy();
        const id = Math.floor(10000 + Math.random() * 90000).toString();
        peer = new Peer(id);
        peer.on('open', (id) => { el('my-id-val').textContent = id; el('status').textContent = "READY"; });
        peer.on('connection', (c) => { dataConn = c; setupChat(); });
        peer.on('call', async (call) => {
            if (confirm("着信です。応答しますか？")) {
                const s = await startMedia(call.options.metadata?.type === 'video');
                if(s) { call.answer(s); setupCall(call, call.options.metadata?.type === 'video'); }
            }
        });
    });

    async function startMedia(v) {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ audio: true, video: v });
            localStream = s;
            if (v) { el('v-area').style.display = 'block'; el('local-video').srcObject = s; }
            el('mic-icon-svg').style.display = 'block';
            return s;
        } catch (e) { alert("カメラ・マイクの許可が必要です(HTTPS推奨)"); return null; }
    }

    function setupCall(call, v) {
        currentCall = call;
        el('setup-area').style.display = 'none';
        el('call-controls').style.display = 'grid';
        el('status').textContent = "IN CALL";
        call.on('stream', (rs) => {
            const t = v ? el('remote-video') : el('remote-audio');
            t.srcObject = rs;
            el('container').classList.add('in-call');
            el('chat-area').style.display = 'flex';
        });
    }

    function setupChat() {
        dataConn.on('data', (d) => addMsg(d, 'them'));
        dataConn.on('open', () => { el('chat-area').style.display = 'flex'; el('container').classList.add('in-call'); });
    }

    function addMsg(m, s) {
        const d = document.createElement('div'); d.className = `msg msg-${s}`; d.textContent = m;
        el('chat-log').appendChild(d); el('chat-log').scrollTop = el('chat-log').scrollHeight;
    }

    el('chat-send').onclick = () => {
        const m = el('chat-msg').value;
        if(m && dataConn) { dataConn.send(m); addMsg(m, 'me'); el('chat-msg').value = ''; }
    };

    el('audio-btn').onclick = () => makeCall(false);
    el('video-btn').onclick = () => makeCall(true);

    async function makeCall(v) {
        const tid = el('target-id').value;
        if (!peer || tid.length !== 5) return;
        dataConn = peer.connect(tid);
        setupChat();
        const s = await startMedia(v);
        if(s) setupCall(peer.call(tid, s, { metadata: { type: v ? 'video' : 'audio' } }), v);
    }

    el('hangup-btn').onclick = () => location.reload();
</script>
</body>
</html>
